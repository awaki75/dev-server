version: "3"
services:
  cassandra:
    image: cassandra:2.1.21
    ports:
      - 9042:9042
      - 9160:9160
    volumes:
      - cassandradata:/var/lib/cassandra
  elasticsearch:
    build: dockerfile/elasticsearch
    ports:
      - 9200:9200
      - 9300:9300
    volumes:
      - elasticsearchdata:/usr/share/elasticsearch/data
    environment:
      - PR_HOST
    command: elasticsearch -Des.cluster.name=my-application -Des.network.publish_host=${PR_HOST}
  redis:
    image: redis:3.2.12
    ports:
      - 6379:6379
  nginx1: &nginx
    image: nginx:1.15.9
    ports:
      - 8180:80
    volumes:
      - ./config/nginx/default.conf:/etc/nginx/conf.d/default.conf.template:ro
    environment:
      PR_EXAMPLES_HOST: ${PR_DOCKER_HOST}:8181
    command: /bin/bash -c "envsubst '$$PR_EXAMPLES_HOST' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"
  tomcat1: &tomcat
    image: tomcat:8.0.53-jre8
    ports:
      - 8181:8080
  nginx2:
    <<: *nginx
    ports:
      - 8280:80
    environment:
      PR_EXAMPLES_HOST: ${PR_DOCKER_HOST}:8281
  tomcat2:
    <<: *tomcat
    ports:
      - 8281:8080
volumes:
  cassandradata:
  elasticsearchdata:
